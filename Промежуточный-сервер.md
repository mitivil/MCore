===============================================
Промежуточный сервер
-----------------------------------------------

Получаем обновления:

	sudo apt-get update
	sudo apt-get upgrade

--
Разрешаем переадресацию портов

	sudo echo 1 > /proc/sys/net/ipv4/ip_forward

Открываем файл /etc/sysctl.conf

	sudo nano /etc/sysctl.conf

	-----
	
	Добавляем в конец файла следующие параметры:
	
net.ipv4.conf.default.forwarding=1
net.ipv4.conf.all.forwarding=1

Закрываем файл CTRL-X y Enter.

Добавляем правила в iptables

	sudo iptables -A INPUT -i tun+ -j ACCEPT
	sudo iptables -A FORWARD -i tun+ -j ACCEPT
	sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
	sudo iptables -t nat -F POSTROUTING
	sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o [Имя сет. интерфейса этого сервера] -j MASQUERADE
	
Добавляем правило для переадресации портов

	sudo iptables -t nat -A PREROUTING -d [IP Адрес промежуточного сервера] -p tcp --dport [Порт промежуточного сервера, в нашем случае 80] -j DNAT --to-dest 10.8.0.6:[Порт клиентского сервера, в нашем случае 80]
	
Для того чтобы правила вступили в силу

	sudo iptables-save
	
Сохраним правила в конфиг файл для подгрузки при перезагрузке.

	sudo iptables-save > /etc/iptables.conf
	
Создаем скрипт применения правил при перезагрузке

	sudo nano /etc/network/if-up.d/rules_ipv4

	-----

	Добавляем следующее:
	
#!/bin/bash
iptables-restore /etc/iptables.conf

Закрываем файл CTRL-X y Enter.

Делаем этот файл исполняемым

	sudo chmod +x /etc/network/if-up.d/rules_ipv4

Проверяем появился ли сетевой интерфейс tun0

	ifconfig
	
