Все настройки IPtables находятся тут: 
        sudo /bin/bash /Systemctl/Iptables-command.sh


===============================================
Промежуточный сервер
-----------------------------------------------

Получаем обновления:

	sudo apt-get update
	sudo apt-get upgrade

Устанавливаем OpenVPN сервер

	sudo apt install -y openvpn
	
Установка Easy-RSA чтобы сгенерировать ключи и получить сертификаты для OpenVPN соединений.

	sudo mkdir /src; cd /src && sudo wget https://github.com/OpenVPN/easy-rsa/archive/master.zip

Устанавливаем Upnzip, если у вас он еще не установлен.

	sudo apt install unzip
	
Распаковываем архив

	sudo unzip master.zip
	cd easy-rsa-master/easyrsa3
	
Запускаем скрипт

	sudo ./easyrsa init-pki
	
Создаем центр сертификации

	sudo ./easyrsa build-ca
	
	-----
	
	Confirm request details:
	
		Отвечаем - yes
	
	-----
	
	Enter New CA Key Passphrase: - Вводим пароль от 4 до 32 символов.
	Re-Enter New CA Key Passphrase: - Повторяем тот же пароль.

И мы получим следующие файлы:
	
	./pki/ca.crt
	./pki/private/ca.key
	
Генерируем запрос на создание сертификата для подключения к этому серверу без пароля.

	sudo ./easyrsa gen-req server nopass
	
	-----
	
	Common Name (eg: your user, host, or server name [server]):
	
		Жмем Enter

Подписываем запрос.

	sudo ./easyrsa sign-req server server
	
	-----
	
	Confirm request details:
		
		Отвечаем - yes
	
	-----
	
	Enter pass phrase for /src/easy-rsa-master/easyrsa3/pki/private/ca.key:
		
		Вводим наш пароль.

Мы получим файл сертификата сервера

	./pki/issued/server.crt
	
Генерируем ключи для клиентского сервера.

	sudo ./easyrsa gen-req client nopass
	
	-----
	
	Common Name (eg: your user, host, or server name [client]):

		Жмем Enter

Подписываем запрос.

	sudo ./easyrsa sign-req client client
	
	-----
	
	Confirm request details:
		
		Отвечаем - yes
	
	-----
	
	Enter pass phrase for /src/easy-rsa-master/easyrsa3/pki/private/ca.key:
		
		Вводим наш пароль.
		
Мы получили файлы для клиентского сервера:

	./pki/private/client.key
	./pki/issued/client.crt
	
Генерируем файл с параметрами Диффи Хеллмана.

	sudo ./easyrsa gen-dh
	
Получили файл:

	./pki/dh.pem
	
Перенесем все созданные ключи и сертификаты в директорию /etc/openvpn

	sudo mv ./pki/dh.pem /etc/openvpn/dh1024.pem
	sudo mv ./pki/private/client.key /etc/openvpn/
	sudo mv ./pki/private/server.key /etc/openvpn/
	sudo mv ./pki/ca.crt /etc/openvpn/
	sudo mv ./pki/issued/client.crt /etc/openvpn/
	sudo mv ./pki/issued/server.crt /etc/openvpn/

Переходим в директорию /etc/openvpn

	cd /etc/openvpn

Через FTP или другим способом, копируем следующие файлы на клиентский сервер
в директорию /etc/openvpn/client

	/etc/openvpn/client.crt
	/etc/openvpn/client.key
	/etc/openvpn/ca.crt
	
Создаем файл и редактируем файл server.conf

	sudo nano server.conf
	
Добавляем следующие параметры:
```
port 1194
proto tcp
dev tun
ca ca.crt
cert server.crt
key server.key
dh dh1024.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
keepalive 10 120
comp-lzo
persist-key
persist-tun
status openvpn-status.log
log openvpn.log
log-append openvpn.log
verb 3
push "redirect-gateway def1"
push "dhcp-option DNS 8.8.8.8"
```
Закрываем файл CTRL-X y Enter.

Перезагружаем наш промежуточный сервер

	sudo reboot
	
Разрешаем переадресацию портов

	sudo echo 1 > /proc/sys/net/ipv4/ip_forward

Открываем файл /etc/sysctl.conf

	sudo nano /etc/sysctl.conf

	-----
	
	Добавляем в конец файла следующие параметры:
	
net.ipv4.conf.default.forwarding=1
net.ipv4.conf.all.forwarding=1

Закрываем файл CTRL-X y Enter.

Добавляем правила в iptables

	sudo iptables -A INPUT -i tun+ -j ACCEPT
	sudo iptables -A FORWARD -i tun+ -j ACCEPT
	sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
	sudo iptables -t nat -F POSTROUTING
	sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o [Имя сет. интерфейса этого сервера] -j MASQUERADE
	
Добавляем правило для переадресации портов

	sudo iptables -t nat -A PREROUTING -d [IP Адрес промежуточного сервера] -p tcp --dport [Порт промежуточного сервера, в нашем случае 80] -j DNAT --to-dest 10.8.0.6:[Порт клиентского сервера, в нашем случае 80]
	
Для того чтобы правила вступили в силу

	sudo iptables-save
	
Сохраним правила в конфиг файл для подгрузки при перезагрузке.

	sudo iptables-save > /etc/iptables.conf
	
Создаем скрипт применения правил при перезагрузке

	sudo nano /etc/network/if-up.d/rules_ipv4

	-----

	Добавляем следующее:
	
#!/bin/bash
iptables-restore /etc/iptables.conf

Закрываем файл CTRL-X y Enter.

Делаем этот файл исполняемым

	sudo chmod +x /etc/network/if-up.d/rules_ipv4

Проверяем появился ли сетевой интерфейс tun0

	ifconfig
	
	
	
	
	
	
	
	
===============================================
Клиентский сервер
-----------------------------------------------

Получаем обновления:

	sudo apt-get update
	sudo apt-get upgrade

Устанавливаем Apache сервер

	sudo apt-get install apache2
	
	Проверяем 80 порт в браузере

Устанавливаем OpenVPN сервер

	sudo apt install -y openvpn

Переходим в директорию /etc/openvpn/client

	cd /etc/openvpn/client
	
Создаем конфигурационный файл клиента

	sudo nano client.conf
	
Добавляем следующие параметры:
```
client
dev tun
proto tcp
remote [Адрес промежуточного сервера]
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert client.crt
key client.key
remote-cert-tls server
comp-lzo
user nobody
group nogroup
cipher AES-256-CBC
keepalive 10 120
verb 3
log /var/log/openvpn/client.log
```

Закрываем файл CTRL-X y Enter.

Устанавливаем права на client.key

	sudo chmod 600 client.key
	
Для автоматического подключения к серверу при перезагрузке.

	sudo systemctl enable openvpn-client@client
	sudo systemctl daemon-reload
	
Подключаемся к серверу

	sudo systemctl start openvpn-client@client
	
Проверяем появился ли сетевой интерфейс tun0

	ifconfig
	
	
=====================================================================
